<!DOCTYPE html>
<html>
<head>
  <title>String Sleuth</title>
  <link rel="stylesheet" href="style.min.css">
  <script src="script.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>String Sleuth</h1>
    <form id="form">
      <div class="input-group">
        <label for="base_url">Base URL:</label>
        <input id="base_url">
      </div>
      <div class="input-group">
        <label for="html">HTML Code or String to Find:</label>
        <textarea id="html"></textarea>
      </div>
      <div class="button-group">
        <input type="submit" value="Search">
        <label for="advanced_options">Advanced Options</label>
        <input type="checkbox" id="advanced_options">
      </div>
    </form>
    <div id="results"></div>
    <div id="advanced_options_container">
      <div class="dropdown">
        <label for="conversion_type">Conversion Type:</label>
        <select id="conversion_type">
          <option value="regular_expressions">Regular Expressions</option>
          <option value="ignore_robots_txt">Ignore Robots.txt</option>
        </select>
      </div>
      <div class="checkbox-group">
        <label for="detect_broken_links">Detect Broken Links:</label>
        <input type="checkbox" id="detect_broken_links">
        <label for="identify_alternative_links">Identify Alternative Links:</label>
        <input type="checkbox" id="identify_alternative_links">
        <label for="optimize_html">Optimize HTML:</label>
        <input type="checkbox" id="optimize_html">
      </div>
    </div>
  </div>

  <script>
    "pages.github.com" === window.location.hostname && document.querySelector("base").setAttribute("href", "/String-Sleuth/");

    const form = document.getElementById("form");
    const advancedOptionsContainer = document.getElementById("advanced_options_container");

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const baseUrl = document.getElementById("base_url").value;
      const html = document.getElementById("html").value;

      if (!baseUrl || !html) {
        alert("Please provide a base URL and HTML.");
        return;
      }

      const conversionType = document.getElementById("conversion_type").value;
      const detectBrokenLinks = document.getElementById("detect_broken_links").checked;
      const identifyAlternativeLinks = document.getElementById("identify_alternative_links").checked;
      const optimizeHtml = document.getElementById("optimize_html").checked;

      searchWebsite(baseUrl, html, {
        conversionType,
        detectBrokenLinks,
        identifyAlternativeLinks,
        optimizeHtml,
      });
    });

    const searchWebsite = (baseUrl, html, options) => {
      const xhr = new XMLHttpRequest();
      xhr.open("GET", baseUrl);
      xhr.setRequestHeader("Content-Type", "text/html");
      xhr.onload = function () {
        if (xhr.status === 200) {
          const response = xhr.responseText;
          const parser = new DOMParser();
          const doc = parser.parseFromString(response, "text/html");

          const elements = doc.querySelectorAll("body *");
          elements.forEach((element) => {
            const textContent = element.textContent;
            const regex = new RegExp(html, "g");

            if (textContent.match(regex)) {
              const htmlWithHighlight = element.parentElement.innerHTML.replace(
                html,
                `<mark>${html}</mark>`
              );
              const textBefore = textContent.substring(0, textContent.indexOf(html));
              const textAfter = textContent.substring(
                textContent.indexOf(html) + html.length
              );

              console.log(`URL: ${window.location.href}`);
              console.log(`Before: ${textBefore}`);
              console.log(`String: ${html}`);
              console.log(`After: ${textAfter}`);
              console.log(`HTML: ${htmlWithHighlight}`);
            }
          });
        } else {
          console.error("Error: " + xhr.statusText);
        }
      };
      xhr.send();
    };

    advancedOptions.addEventListener("change", (e) => {
      e.target.checked
        ? (advancedOptionsContainer.style.display = "block")
        : (advancedOptionsContainer.style.display = "none");
    });
  </script>
</body>
</html>
